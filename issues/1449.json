{
  "type": "issue",
  "issue": {
    "id": 2020756839,
    "node_id": "I_kwDOAP4Jqs54ck1n",
    "url": "https://api.github.com/repos/bitcoin-core/secp256k1/issues/1449",
    "repository_url": "https://api.github.com/repos/bitcoin-core/secp256k1",
    "labels_url": "https://api.github.com/repos/bitcoin-core/secp256k1/issues/1449/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin-core/secp256k1/issues/1449/comments",
    "events_url": "https://api.github.com/repos/bitcoin-core/secp256k1/issues/1449/events",
    "html_url": "https://github.com/bitcoin-core/secp256k1/issues/1449",
    "number": 1449,
    "state": "open",
    "state_reason": null,
    "title": "Prefix all macros with SECP256K1_",
    "body": "We prefix all global names with `secp256k1_` to avoid name collisions and ensure that the library can be header-only. If we believe in this, we should probably do the same for macros. (And even we don't believe in this, I tend to think that having a prefix everywhere is just more consistent.)  \r\n\r\nPerhaps it makes sense to separate internal macros and external \"config\" macros as suggested in https://github.com/bitcoin-core/secp256k1/pull/1121#issuecomment-1176294919 by @sipa:\r\n> I think it may be useful to have a strict separation between \"external\" macros (provided in config.h, or through compiler -D flags) flags, and \"internal\" macros which guide the actual source code conditionals? \r\n\r\nAlso, we could reconsider the naming of the `VERIFY` macros as I suggested in #1381:\r\n> And while we're touching this anyway, we could consider renaming \"check\" to \"assert\", which is a more precise term. (In fact, if we redefine VERIFY_CHECK to be empty in production, we have almost reimplemented assert.h...)\r\n",
    "user": {
      "login": "real-or-random",
      "id": 1071625,
      "node_id": "MDQ6VXNlcjEwNzE2MjU=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1071625?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/real-or-random",
      "html_url": "https://github.com/real-or-random",
      "followers_url": "https://api.github.com/users/real-or-random/followers",
      "following_url": "https://api.github.com/users/real-or-random/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/real-or-random/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/real-or-random/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/real-or-random/subscriptions",
      "organizations_url": "https://api.github.com/users/real-or-random/orgs",
      "repos_url": "https://api.github.com/users/real-or-random/repos",
      "events_url": "https://api.github.com/users/real-or-random/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/real-or-random/received_events",
      "type": "User",
      "site_admin": false
    },
    "labels": [
      {
        "id": 5492448291,
        "node_id": "LA_kwDOAP4Jqs8AAAABR2AcIw",
        "url": "https://api.github.com/repos/bitcoin-core/secp256k1/labels/refactor/smell",
        "name": "refactor/smell",
        "description": "",
        "color": "FBCA04",
        "default": false
      },
      {
        "id": 5922723218,
        "node_id": "LA_kwDOAP4Jqs8AAAABYQWVkg",
        "url": "https://api.github.com/repos/bitcoin-core/secp256k1/labels/development",
        "name": "development",
        "description": "processes, conventions, developer documentation, etc.",
        "color": "E2E0F5",
        "default": false
      }
    ],
    "assignees": [],
    "author_association": "CONTRIBUTOR",
    "locked": false,
    "comments": 0,
    "created_at": "2023-12-01T12:07:46Z",
    "updated_at": "2023-12-01T12:10:36Z"
  },
  "events": [
    {
      "event": "labeled",
      "id": 11121457210,
      "node_id": "LE_lADOAP4Jqs54ck1nzwAAAAKW4_g6",
      "url": "https://api.github.com/repos/bitcoin-core/secp256k1/issues/events/11121457210",
      "actor": {
        "login": "real-or-random",
        "id": 1071625,
        "node_id": "MDQ6VXNlcjEwNzE2MjU=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1071625?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/real-or-random",
        "html_url": "https://github.com/real-or-random",
        "followers_url": "https://api.github.com/users/real-or-random/followers",
        "following_url": "https://api.github.com/users/real-or-random/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/real-or-random/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/real-or-random/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/real-or-random/subscriptions",
        "organizations_url": "https://api.github.com/users/real-or-random/orgs",
        "repos_url": "https://api.github.com/users/real-or-random/repos",
        "events_url": "https://api.github.com/users/real-or-random/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/real-or-random/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-12-01T12:07:46Z",
      "label": {
        "name": "refactor/smell",
        "color": "FBCA04"
      }
    },
    {
      "event": "labeled",
      "id": 11121457220,
      "node_id": "LE_lADOAP4Jqs54ck1nzwAAAAKW4_hE",
      "url": "https://api.github.com/repos/bitcoin-core/secp256k1/issues/events/11121457220",
      "actor": {
        "login": "real-or-random",
        "id": 1071625,
        "node_id": "MDQ6VXNlcjEwNzE2MjU=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1071625?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/real-or-random",
        "html_url": "https://github.com/real-or-random",
        "followers_url": "https://api.github.com/users/real-or-random/followers",
        "following_url": "https://api.github.com/users/real-or-random/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/real-or-random/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/real-or-random/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/real-or-random/subscriptions",
        "organizations_url": "https://api.github.com/users/real-or-random/orgs",
        "repos_url": "https://api.github.com/users/real-or-random/repos",
        "events_url": "https://api.github.com/users/real-or-random/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/real-or-random/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-12-01T12:07:46Z",
      "label": {
        "name": "development",
        "color": "E2E0F5"
      }
    },
    {
      "event": "mentioned",
      "id": 11121457287,
      "node_id": "MEE_lADOAP4Jqs54ck1nzwAAAAKW4_iH",
      "url": "https://api.github.com/repos/bitcoin-core/secp256k1/issues/events/11121457287",
      "actor": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-12-01T12:07:46Z"
    },
    {
      "event": "subscribed",
      "id": 11121457295,
      "node_id": "SE_lADOAP4Jqs54ck1nzwAAAAKW4_iP",
      "url": "https://api.github.com/repos/bitcoin-core/secp256k1/issues/events/11121457295",
      "actor": {
        "login": "sipa",
        "id": 548488,
        "node_id": "MDQ6VXNlcjU0ODQ4OA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/548488?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/sipa",
        "html_url": "https://github.com/sipa",
        "followers_url": "https://api.github.com/users/sipa/followers",
        "following_url": "https://api.github.com/users/sipa/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/sipa/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/sipa/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/sipa/subscriptions",
        "organizations_url": "https://api.github.com/users/sipa/orgs",
        "repos_url": "https://api.github.com/users/sipa/repos",
        "events_url": "https://api.github.com/users/sipa/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/sipa/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-12-01T12:07:46Z"
    },
    {
      "event": "cross-referenced",
      "id": null,
      "node_id": null,
      "url": null,
      "actor": {
        "login": "real-or-random",
        "id": 1071625,
        "node_id": "MDQ6VXNlcjEwNzE2MjU=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1071625?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/real-or-random",
        "html_url": "https://github.com/real-or-random",
        "followers_url": "https://api.github.com/users/real-or-random/followers",
        "following_url": "https://api.github.com/users/real-or-random/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/real-or-random/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/real-or-random/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/real-or-random/subscriptions",
        "organizations_url": "https://api.github.com/users/real-or-random/orgs",
        "repos_url": "https://api.github.com/users/real-or-random/repos",
        "events_url": "https://api.github.com/users/real-or-random/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/real-or-random/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-12-01T12:08:18Z",
      "updated_at": "2023-12-01T12:08:18Z",
      "source": {
        "issue": {
          "id": 1836914700,
          "node_id": "PR_kwDOAP4Jqs5XNOLl",
          "url": "https://api.github.com/repos/bitcoin-core/secp256k1/issues/1393",
          "repository_url": "https://api.github.com/repos/bitcoin-core/secp256k1",
          "labels_url": "https://api.github.com/repos/bitcoin-core/secp256k1/issues/1393/labels%7B/name%7D",
          "comments_url": "https://api.github.com/repos/bitcoin-core/secp256k1/issues/1393/comments",
          "events_url": "https://api.github.com/repos/bitcoin-core/secp256k1/issues/1393/events",
          "html_url": "https://github.com/bitcoin-core/secp256k1/pull/1393",
          "number": 1393,
          "state": "closed",
          "state_reason": null,
          "title": "Implement new policy for VERIFY_CHECK and #ifdef VERIFY (issue #1381)",
          "body": "As suggested in #1381, this PR reworks the policy for VERIFY_CHECK and when to use #ifdef VERIFY, by:\r\n- redefining VERIFY_CHECK to empty in production (non-VERIFY) mode\r\n- removing many then superflous #ifdef VERIFY blocks (if they exclusively contained VERIFY_CHECKs)\r\n- introducing uppercase macros around verify_ functions and using them for better readabiliy\r\n\r\nWhat is _not_ included yet is the proposed renaming from \"_check\" to \"_assert\":\r\n> And while we're touching this anyway, we could consider renaming \"check\" to \"assert\", which is a more precise term. (In fact, if we redefine VERIFY_CHECK to be empty in production, we have almost reimplemented assert.h...)\r\n\r\nThis should be easy to achieve with simple search-and-replace (e.g. using sed), but I was hesitant as this would probably case annoying merge conflicts on some of the open PRs. Happy to add this if the rename if desired (#1381 didn't get any feedback about the renaming idea yet).",
          "user": {
            "login": "theStack",
            "id": 91535,
            "node_id": "MDQ6VXNlcjkxNTM1",
            "avatar_url": "https://avatars.githubusercontent.com/u/91535?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/theStack",
            "html_url": "https://github.com/theStack",
            "followers_url": "https://api.github.com/users/theStack/followers",
            "following_url": "https://api.github.com/users/theStack/following%7B/other_user%7D",
            "gists_url": "https://api.github.com/users/theStack/gists%7B/gist_id%7D",
            "starred_url": "https://api.github.com/users/theStack/starred%7B/owner%7D%7B/repo%7D",
            "subscriptions_url": "https://api.github.com/users/theStack/subscriptions",
            "organizations_url": "https://api.github.com/users/theStack/orgs",
            "repos_url": "https://api.github.com/users/theStack/repos",
            "events_url": "https://api.github.com/users/theStack/events%7B/privacy%7D",
            "received_events_url": "https://api.github.com/users/theStack/received_events",
            "type": "User",
            "site_admin": false
          },
          "labels": [
            {
              "id": 5492448291,
              "node_id": "LA_kwDOAP4Jqs8AAAABR2AcIw",
              "url": "https://api.github.com/repos/bitcoin-core/secp256k1/labels/refactor/smell",
              "name": "refactor/smell",
              "description": "",
              "color": "FBCA04",
              "default": false
            }
          ],
          "assignees": [],
          "author_association": "CONTRIBUTOR",
          "locked": false,
          "comments": 4,
          "pull_request": {
            "url": "https://api.github.com/repos/bitcoin-core/secp256k1/pulls/1393",
            "html_url": "https://github.com/bitcoin-core/secp256k1/pull/1393",
            "diff_url": "https://github.com/bitcoin-core/secp256k1/pull/1393.diff",
            "patch_url": "https://github.com/bitcoin-core/secp256k1/pull/1393.patch"
          },
          "closed_at": "2023-12-01T11:59:53Z",
          "created_at": "2023-08-04T15:00:17Z",
          "updated_at": "2023-12-01T12:37:09Z"
        },
        "type": "issue"
      }
    },
    {
      "event": "cross-referenced",
      "id": null,
      "node_id": null,
      "url": null,
      "actor": {
        "login": "real-or-random",
        "id": 1071625,
        "node_id": "MDQ6VXNlcjEwNzE2MjU=",
        "avatar_url": "https://avatars.githubusercontent.com/u/1071625?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/real-or-random",
        "html_url": "https://github.com/real-or-random",
        "followers_url": "https://api.github.com/users/real-or-random/followers",
        "following_url": "https://api.github.com/users/real-or-random/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/real-or-random/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/real-or-random/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/real-or-random/subscriptions",
        "organizations_url": "https://api.github.com/users/real-or-random/orgs",
        "repos_url": "https://api.github.com/users/real-or-random/repos",
        "events_url": "https://api.github.com/users/real-or-random/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/real-or-random/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2023-12-01T12:09:39Z",
      "updated_at": "2023-12-01T12:09:39Z",
      "source": {
        "issue": {
          "id": 1817978283,
          "node_id": "I_kwDOAP4Jqs5sXCWr",
          "url": "https://api.github.com/repos/bitcoin-core/secp256k1/issues/1381",
          "repository_url": "https://api.github.com/repos/bitcoin-core/secp256k1",
          "labels_url": "https://api.github.com/repos/bitcoin-core/secp256k1/issues/1381/labels%7B/name%7D",
          "comments_url": "https://api.github.com/repos/bitcoin-core/secp256k1/issues/1381/comments",
          "events_url": "https://api.github.com/repos/bitcoin-core/secp256k1/issues/1381/events",
          "html_url": "https://github.com/bitcoin-core/secp256k1/issues/1381",
          "number": 1381,
          "state": "closed",
          "state_reason": "completed",
          "title": "Policy for VERIFY_CHECK and #ifdef VERIFY  ",
          "body": "### Current situation\r\n\r\nThe purpose of `VERIFY_CHECK(cond)` is to assert `cond` in test builds, i.e., when `VERIFY` is defined. While `cond` is supposed to have no side effects, `VERIFY_CHECK` will evaluate it even in production builds, to make sure that no side effects are masked in production builds.\r\n\r\nIn the case of simple `cond`, we can rely on the ability of the compiler to detect that `cond` has no side effects and to omit its evaluation entirely. However, many recently introduced `cond` are neither simple nor have negligible computation costs. In this case, we usually wrap `VERIFY_CHECK(cond)` in an `#ifdef VERIFY` block, which forces the evaluation to be omitted in production, at the cost of foregoing the aforementioned \"side-effect safety\" of `VERIFY_CHECK`. [1]\r\n\r\nOn top of this, we now have (full) functions like `secp256k1_fe_verify`, which internally perform `VERIFY_CHECK`s.\r\n\r\nI don't think anything we currently do is wrong, but sometimes the borders are a bit arbitrary, and with a mix of `#ifdef VERIFY` and no `#ifdef VERIFY`, and a mix of uppercase and lowercase, also readability and consistency suffer.\r\n\r\n### Options\r\n\r\nWhen it comes to forcing evaluations to be omitted, we can either keep the current convention and force omitting on a case-by-case basis. Alternatively, we could just always force omitting, e.g., by defining `VERIFY_CHECK` to be empty in production. That will keep things simple and save us the decision of whether to force omitting. The comment in https://github.com/bitcoin-core/secp256k1/pull/904#issuecomment-1540601651 appears to agree with this.  \r\n\r\nWhen it comes to readability, I think that `#ifdef` blocks tend to clutter the code. If we redefine `VERIFY_CHECK` to be empty in production, we could omit many `#ifdef` lines. Even if we keep two types of `VERIFY_CHECK`s, I suggest introducing a separate macro instead to replace `#ifdef`.\r\n\r\nOne remaining purpose of the `#ifdef`s is to highlight the test code blocks, e.g., [when we call `secp256k1_fe_verify` in `field_impl.h`](https://github.com/bitcoin-core/secp256k1/blob/c545fdc374964424683d9dac31a828adedabe860/src/field_impl.h#L34-L45). But then we could just make these function names uppercase. And if we want blocks/grouping for better readability, we can simply use empty lines instead of `#ifdef` lines.\r\n\r\nSo I suggest \r\n - redefining `VERIFY_CHECK` to be empty in production\r\n - renaming `_check` functions to uppercase. \r\n \r\nAnd while we're touching this anyway, we could consider renaming \"check\" to \"assert\", which is a more precise term. (In fact, if we redefine `VERIFY_CHECK` to be empty in production, we have almost reimplemented `assert.h`...)\r\n\r\nDoes this make sense?\r\n\r\n---\r\n\r\n[1] One idea was to improve this situation was to introduce a C hack that will tell us whether a compiler is able to determine that a `check` has no side effects, but I agree with https://github.com/bitcoin-core/secp256k1/pull/904#issuecomment-1540601651 that this is not the way to go. In addition to the points brought up by @sipa, relying on the compiler is just very brittle, with optimizations depending on compiler versions and flags.\r\n",
          "user": {
            "login": "real-or-random",
            "id": 1071625,
            "node_id": "MDQ6VXNlcjEwNzE2MjU=",
            "avatar_url": "https://avatars.githubusercontent.com/u/1071625?v=4",
            "gravatar_id": "",
            "url": "https://api.github.com/users/real-or-random",
            "html_url": "https://github.com/real-or-random",
            "followers_url": "https://api.github.com/users/real-or-random/followers",
            "following_url": "https://api.github.com/users/real-or-random/following%7B/other_user%7D",
            "gists_url": "https://api.github.com/users/real-or-random/gists%7B/gist_id%7D",
            "starred_url": "https://api.github.com/users/real-or-random/starred%7B/owner%7D%7B/repo%7D",
            "subscriptions_url": "https://api.github.com/users/real-or-random/subscriptions",
            "organizations_url": "https://api.github.com/users/real-or-random/orgs",
            "repos_url": "https://api.github.com/users/real-or-random/repos",
            "events_url": "https://api.github.com/users/real-or-random/events%7B/privacy%7D",
            "received_events_url": "https://api.github.com/users/real-or-random/received_events",
            "type": "User",
            "site_admin": false
          },
          "labels": [
            {
              "id": 165017692,
              "node_id": "MDU6TGFiZWwxNjUwMTc2OTI=",
              "url": "https://api.github.com/repos/bitcoin-core/secp256k1/labels/assurance",
              "name": "assurance",
              "description": "",
              "color": "A6DF3D",
              "default": false
            },
            {
              "id": 5492448291,
              "node_id": "LA_kwDOAP4Jqs8AAAABR2AcIw",
              "url": "https://api.github.com/repos/bitcoin-core/secp256k1/labels/refactor/smell",
              "name": "refactor/smell",
              "description": "",
              "color": "FBCA04",
              "default": false
            }
          ],
          "assignees": [],
          "author_association": "CONTRIBUTOR",
          "locked": false,
          "comments": 5,
          "closed_at": "2023-12-01T11:59:54Z",
          "created_at": "2023-07-24T09:08:22Z",
          "updated_at": "2023-12-01T12:09:55Z"
        },
        "type": "issue"
      }
    }
  ]
}