{
  "type": "issue",
  "issue": {
    "id": 369449436,
    "node_id": "MDU6SXNzdWUzNjk0NDk0MzY=",
    "url": "https://api.github.com/repos/bitcoin-core/secp256k1/issues/565",
    "repository_url": "https://api.github.com/repos/bitcoin-core/secp256k1",
    "labels_url": "https://api.github.com/repos/bitcoin-core/secp256k1/issues/565/labels%7B/name%7D",
    "comments_url": "https://api.github.com/repos/bitcoin-core/secp256k1/issues/565/comments",
    "events_url": "https://api.github.com/repos/bitcoin-core/secp256k1/issues/565/events",
    "html_url": "https://github.com/bitcoin-core/secp256k1/issues/565",
    "number": 565,
    "state": "closed",
    "state_reason": "completed",
    "title": "Wrong power of `g` / `secp256k1_fe_get_b32` wrong for small field elements?",
    "body": "Maybe I am using the library wrong, but it seems I get wrong results for `g*55087` (and, in general, about 0.01% of random multiples of g).\r\n\r\nI am using this code:\r\n```\r\n#include <stdio.h>\r\n\r\n#pragma GCC diagnostic push\r\n#pragma GCC diagnostic ignored \"-Wconversion\"\r\n#pragma GCC diagnostic ignored \"-Wsign-conversion\"\r\n#define HAVE_CONFIG_H 1\r\n#include \"secp256k1.h\"\r\n#include \"scalar_impl.h\"\r\n#include \"num_impl.h\"\r\n#include \"field_impl.h\"\r\n#include \"group_impl.h\"\r\n#include \"ecmult_impl.h\"\r\n#include \"scratch_impl.h\"\r\n#pragma GCC diagnostic pop\r\n\r\nvoid print_hex(unsigned char buf[]){\r\n  int i;\r\n  for (i = 0; i < 32; i++)\r\n  {\r\n      printf(\"%02x\", buf[i]);\r\n  }\r\n  printf(\"\\n\");\r\n}\r\n\r\nchar *map;\r\n\r\nint main (int argc, char* argv[]) {\r\n  if (argc < 2) {\r\n    printf(\"Usage: %s n\\n\", argv[0]);\r\n    exit(1);\r\n  }\r\n\r\n  unsigned long n = atoi(argv[1]);\r\n\r\n  // endianness\r\n  unsigned char n_b[32];\r\n  for (int i = 0; i<32; i++) {n_b[i] = 0; }\r\n  // needs to be big endian (intel is little endian)\r\n  *(uint64_t*)(&n_b[(256 - 64)/8]) = htobe64(n);\r\n\r\n  secp256k1_scalar n_s;\r\n  secp256k1_scalar_set_b32(&n_s, n_b, NULL);\r\n\r\n  secp256k1_scalar null_s;\r\n  secp256k1_scalar_set_int(&null_s, 0);\r\n\r\n  secp256k1_gej g;\r\n  secp256k1_gej_set_ge(&g, &secp256k1_ge_const_g);\r\n\r\n  unsigned char pub[32];\r\n\r\n  secp256k1_ecmult_context ctx;\r\n  secp256k1_ecmult_context_init(&ctx);\r\n\r\n  secp256k1_gej xj;\r\n  secp256k1_ge x;\r\n  // set x to G*n\r\n  secp256k1_ecmult(&ctx, &xj, &g, &n_s, &null_s);\r\n  secp256k1_ge_set_gej(&x, &xj);\r\n  secp256k1_fe_get_b32(pub, &(x.x));\r\n  print_hex(pub);\r\n}\r\n```\r\nIf I run this:\r\n```\r\n$ make multiple-of-g\r\ngcc -Wconversion -Wno-sign-conversion  -O -lrt -g -lgmp  -I. -Isecp256k1/src multiple-of-g.c -o multiple-of-g\r\n$ ./multiple-of-g 55087\r\n00020936f0b63e3a3552f8021dfa94333c4c61934b76385a23249c86ec40e6dc\r\n```\r\nbut using a different library I get \r\n```\r\n$ ipython3\r\nIn [1]: import fastecdsa.curve\r\n   ...: c = fastecdsa.curve.secp256k1\r\n   ...: n = 55087\r\n   ...: x = c.G*n;\r\n   ...: print(x.x.to_bytes(32,'big').hex())\r\n   ...: \r\n00020936f0b63e3a3552f8021dfa94333c4c61934b76385a23249c87ec40eaad\r\n```\r\n\r\nNote that just a few bits differ in the lower end.\r\n```\r\n00020936f0b63e3a3552f8021dfa94333c4c61934b76385a23249c86ec40e6dc\r\n00020936f0b63e3a3552f8021dfa94333c4c61934b76385a23249c87ec40eaad\r\n```",
    "user": {
      "login": "nomeata",
      "id": 148037,
      "node_id": "MDQ6VXNlcjE0ODAzNw==",
      "avatar_url": "https://avatars.githubusercontent.com/u/148037?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/nomeata",
      "html_url": "https://github.com/nomeata",
      "followers_url": "https://api.github.com/users/nomeata/followers",
      "following_url": "https://api.github.com/users/nomeata/following%7B/other_user%7D",
      "gists_url": "https://api.github.com/users/nomeata/gists%7B/gist_id%7D",
      "starred_url": "https://api.github.com/users/nomeata/starred%7B/owner%7D%7B/repo%7D",
      "subscriptions_url": "https://api.github.com/users/nomeata/subscriptions",
      "organizations_url": "https://api.github.com/users/nomeata/orgs",
      "repos_url": "https://api.github.com/users/nomeata/repos",
      "events_url": "https://api.github.com/users/nomeata/events%7B/privacy%7D",
      "received_events_url": "https://api.github.com/users/nomeata/received_events",
      "type": "User",
      "site_admin": false
    },
    "labels": [],
    "assignees": [],
    "author_association": "NONE",
    "locked": false,
    "comments": 3,
    "closed_at": "2018-10-12T15:01:16Z",
    "created_at": "2018-10-12T08:27:29Z",
    "updated_at": "2019-02-28T20:06:40Z"
  },
  "events": [
    {
      "event": "commented",
      "id": 429318995,
      "node_id": "MDEyOklzc3VlQ29tbWVudDQyOTMxODk5NQ==",
      "url": "https://api.github.com/repos/bitcoin-core/secp256k1/issues/comments/429318995",
      "actor": {
        "login": "peterdettman",
        "id": 3423981,
        "node_id": "MDQ6VXNlcjM0MjM5ODE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3423981?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/peterdettman",
        "html_url": "https://github.com/peterdettman",
        "followers_url": "https://api.github.com/users/peterdettman/followers",
        "following_url": "https://api.github.com/users/peterdettman/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/peterdettman/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/peterdettman/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/peterdettman/subscriptions",
        "organizations_url": "https://api.github.com/users/peterdettman/orgs",
        "repos_url": "https://api.github.com/users/peterdettman/repos",
        "events_url": "https://api.github.com/users/peterdettman/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/peterdettman/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2018-10-12T13:06:42Z",
      "updated_at": "2018-10-12T13:06:42Z",
      "author_association": "CONTRIBUTOR",
      "body": "/** Convert a field element to a 32-byte big endian value. **Requires the input to be normalized** */\r\nstatic void secp256k1_fe_get_b32(unsigned char *r, const secp256k1_fe *a);\r\n\r\nYou need to normalise the field element before extracting it:\r\n```\r\n    secp256k1_fe_normalize(&(x.x));\r\n    secp256k1_fe_get_b32(pub, &(x.x));\r\n\r\n```",
      "user": {
        "login": "peterdettman",
        "id": 3423981,
        "node_id": "MDQ6VXNlcjM0MjM5ODE=",
        "avatar_url": "https://avatars.githubusercontent.com/u/3423981?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/peterdettman",
        "html_url": "https://github.com/peterdettman",
        "followers_url": "https://api.github.com/users/peterdettman/followers",
        "following_url": "https://api.github.com/users/peterdettman/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/peterdettman/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/peterdettman/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/peterdettman/subscriptions",
        "organizations_url": "https://api.github.com/users/peterdettman/orgs",
        "repos_url": "https://api.github.com/users/peterdettman/repos",
        "events_url": "https://api.github.com/users/peterdettman/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/peterdettman/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin-core/secp256k1/issues/565#issuecomment-429318995",
      "issue_url": "https://api.github.com/repos/bitcoin-core/secp256k1/issues/565"
    },
    {
      "event": "commented",
      "id": 429356145,
      "node_id": "MDEyOklzc3VlQ29tbWVudDQyOTM1NjE0NQ==",
      "url": "https://api.github.com/repos/bitcoin-core/secp256k1/issues/comments/429356145",
      "actor": {
        "login": "nomeata",
        "id": 148037,
        "node_id": "MDQ6VXNlcjE0ODAzNw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/148037?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/nomeata",
        "html_url": "https://github.com/nomeata",
        "followers_url": "https://api.github.com/users/nomeata/followers",
        "following_url": "https://api.github.com/users/nomeata/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/nomeata/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/nomeata/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/nomeata/subscriptions",
        "organizations_url": "https://api.github.com/users/nomeata/orgs",
        "repos_url": "https://api.github.com/users/nomeata/repos",
        "events_url": "https://api.github.com/users/nomeata/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/nomeata/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2018-10-12T15:01:16Z",
      "updated_at": "2018-10-12T15:05:43Z",
      "author_association": "NONE",
      "body": "Ah, darn. I knew it had to be a bug in my code :/ Thanks!",
      "user": {
        "login": "nomeata",
        "id": 148037,
        "node_id": "MDQ6VXNlcjE0ODAzNw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/148037?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/nomeata",
        "html_url": "https://github.com/nomeata",
        "followers_url": "https://api.github.com/users/nomeata/followers",
        "following_url": "https://api.github.com/users/nomeata/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/nomeata/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/nomeata/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/nomeata/subscriptions",
        "organizations_url": "https://api.github.com/users/nomeata/orgs",
        "repos_url": "https://api.github.com/users/nomeata/repos",
        "events_url": "https://api.github.com/users/nomeata/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/nomeata/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin-core/secp256k1/issues/565#issuecomment-429356145",
      "issue_url": "https://api.github.com/repos/bitcoin-core/secp256k1/issues/565"
    },
    {
      "event": "closed",
      "id": 1900975336,
      "node_id": "MDExOkNsb3NlZEV2ZW50MTkwMDk3NTMzNg==",
      "url": "https://api.github.com/repos/bitcoin-core/secp256k1/issues/events/1900975336",
      "actor": {
        "login": "nomeata",
        "id": 148037,
        "node_id": "MDQ6VXNlcjE0ODAzNw==",
        "avatar_url": "https://avatars.githubusercontent.com/u/148037?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/nomeata",
        "html_url": "https://github.com/nomeata",
        "followers_url": "https://api.github.com/users/nomeata/followers",
        "following_url": "https://api.github.com/users/nomeata/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/nomeata/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/nomeata/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/nomeata/subscriptions",
        "organizations_url": "https://api.github.com/users/nomeata/orgs",
        "repos_url": "https://api.github.com/users/nomeata/repos",
        "events_url": "https://api.github.com/users/nomeata/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/nomeata/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2018-10-12T15:01:16Z"
    },
    {
      "event": "commented",
      "id": 468418508,
      "node_id": "MDEyOklzc3VlQ29tbWVudDQ2ODQxODUwOA==",
      "url": "https://api.github.com/repos/bitcoin-core/secp256k1/issues/comments/468418508",
      "actor": {
        "login": "gmaxwell",
        "id": 858454,
        "node_id": "MDQ6VXNlcjg1ODQ1NA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/858454?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/gmaxwell",
        "html_url": "https://github.com/gmaxwell",
        "followers_url": "https://api.github.com/users/gmaxwell/followers",
        "following_url": "https://api.github.com/users/gmaxwell/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/gmaxwell/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/gmaxwell/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/gmaxwell/subscriptions",
        "organizations_url": "https://api.github.com/users/gmaxwell/orgs",
        "repos_url": "https://api.github.com/users/gmaxwell/repos",
        "events_url": "https://api.github.com/users/gmaxwell/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/gmaxwell/received_events",
        "type": "User",
        "site_admin": false
      },
      "commit_id": null,
      "commit_url": null,
      "created_at": "2019-02-28T20:06:40Z",
      "updated_at": "2019-02-28T20:06:40Z",
      "author_association": "CONTRIBUTOR",
      "body": "As an aside, if you'd complied with -DVERIFY it would have thrown an assert when you ran get on a non-normalized number.",
      "user": {
        "login": "gmaxwell",
        "id": 858454,
        "node_id": "MDQ6VXNlcjg1ODQ1NA==",
        "avatar_url": "https://avatars.githubusercontent.com/u/858454?v=4",
        "gravatar_id": "",
        "url": "https://api.github.com/users/gmaxwell",
        "html_url": "https://github.com/gmaxwell",
        "followers_url": "https://api.github.com/users/gmaxwell/followers",
        "following_url": "https://api.github.com/users/gmaxwell/following%7B/other_user%7D",
        "gists_url": "https://api.github.com/users/gmaxwell/gists%7B/gist_id%7D",
        "starred_url": "https://api.github.com/users/gmaxwell/starred%7B/owner%7D%7B/repo%7D",
        "subscriptions_url": "https://api.github.com/users/gmaxwell/subscriptions",
        "organizations_url": "https://api.github.com/users/gmaxwell/orgs",
        "repos_url": "https://api.github.com/users/gmaxwell/repos",
        "events_url": "https://api.github.com/users/gmaxwell/events%7B/privacy%7D",
        "received_events_url": "https://api.github.com/users/gmaxwell/received_events",
        "type": "User",
        "site_admin": false
      },
      "html_url": "https://github.com/bitcoin-core/secp256k1/issues/565#issuecomment-468418508",
      "issue_url": "https://api.github.com/repos/bitcoin-core/secp256k1/issues/565"
    }
  ]
}